# nh-lighting
![macOS](https://img.shields.io/badge/os-macOS-green.svg?style=flat)
![Linux](https://img.shields.io/badge/os-linux-green.svg?style=flat)
![MIT](https://img.shields.io/badge/license-MIT-blue.svg?style=flat)
![](https://img.shields.io/badge/Swift-4.0-orange.svg?style=flat)

Server side swift for the hackspace automated lighting

## macOS
Code can be build with either the Xcode project or with `swift build`

## Docker deployment
Currently this is running on Queen

The PADockerfiles are generated by Perfect Assistant 3.0

### Prep work

Adding the instrumentation network to docker (only needs to be done once)
```bash
sudo docker network create -d macvlan  \
    --subnet=192.168.0.0/24  \
    --ip-range=192.168.0.128/25 \
    --gateway=192.168.0.1  \
    -o parent=eth0.3 instrumentation
```

Build the intermediary docker image with our dependencies, only needs doing if `PADockerfile_build` has changed 
```bash
sudo docker build -f PADockerfile_build -t perfectassistant/nh-lighting .
```

### Compiling

Use our image to compile 
```bash
sudo docker run \
    --volume=/home/dpslwk/github/instrumentation-lighting:/perfectbuild \
    --volume=/home/dpslwk/github/instrumentation-lighting/.packages_lin:/perfectbuild/Packages \
    --volume=/home/dpslwk/github/instrumentation-lighting/.build_lin:/perfectbuild/.build \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.pins:/perfectbuild/Package.pins \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.resolved:/perfectbuild/Package.resolved \
    --workdir=/perfectbuild --rm -t perfectassistant/nh-lighting swift build
```

### Running in place 
Running with files from current location, usefully for testing and change iteration

Create a container
```bash
sudo docker create \
    --volume=/home/dpslwk/github/instrumentation-lighting:/perfectbuild \
    --volume=/home/dpslwk/github/instrumentation-lighting/.packages_lin:/perfectbuild/Packages \
    --volume=/home/dpslwk/github/instrumentation-lighting/.build_lin:/perfectbuild/.build \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.pins:/perfectbuild/Package.pins \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.resolved:/perfectbuild/Package.resolved \
    --workdir=/perfectbuild --rm -t -p 8181:8181 --name nh-lighting perfectassistant/nh-lighting .build_lin/debug/nh-lighting
```

Connect our container to the instrumentation network
```bash
sudo docker network connect instrumentation nh-lighting
```

and start the container
```bash
sudo docker start nh-lighting
```

### Running with deployment image
For long term deployment its better to build an images with all the files included

Compile for release
```bash
sudo docker run \
    --volume=/home/dpslwk/github/instrumentation-lighting:/perfectbuild \
    --volume=/home/dpslwk/github/instrumentation-lighting/.packages_lin:/perfectbuild/Packages \
    --volume=/home/dpslwk/github/instrumentation-lighting/.build_lin:/perfectbuild/.build \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.pins:/perfectbuild/Package.pins \
    --volume=/home/dpslwk/github/instrumentation-lighting/.package_lin.resolved:/perfectbuild/Package.resolved \
    --workdir=/perfectbuild --rm -t perfectassistant/nh-lighting swift build -c release
```

Build a deploy image
```bash
sudo docker build -f PADockerfile_deploy -t perfectassistant/nh-lighting:deploy .
```

Create a container using this image, connect to the instrumentation network and start the container
```bash
sudo docker create \
    --restart=unless-stopped -t -p 8181:8181 --name nh-lighting perfectassistant/nh-lighting:deploy 
sudo docker network connect instrumentation nh-lighting
sudo docker start nh-lighting
```

### Running with docker-compose
If you have docker-compose installed you can save yourself some typing

Compile with dockerised build environment
```bash
docker-compose -f build.yml up --build
```

Run in place
```bash
docker-compose up --build --detach
```

See build.yml and docker-compose.yml for further information

## DB reload
A SIGHUB will cause force a db reload

### macOS
```bash
pkill -1 nh-lighting
```

### Docker
```bash
sudo docker kill --signal=HUP nh-lighting
```
